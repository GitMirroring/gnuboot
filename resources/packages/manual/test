#!/usr/bin/env bash
# Copyright (C) 2025 Denis 'GNUtoo' Carikli <GNUtoo@cyberdimension.org>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
set -e

topdir="$(realpath "$(dirname "$(dirname "$(dirname "$(dirname "$0")")")")")"
progname="resources/packages/manual/test"
rev="$("${topdir}"/resources/wrapper/git describe --tags HEAD)"

. "${topdir}"/resources/scripts/misc/sysexits.sh

usage()
{
    local progname="$1"

    printf "Usage: %s [options]\n\n" "${progname}"
    printf "Available options:\n"
    printf "\t-h, --help\n"
    printf "\t\tDisplay this help and exit.\n"
}

# The manual (and the commands that we test in
# test_build_guix_system_images) depend on files that are generated by
# ./configure.
generate_autotools_files()
{
    cd "${topdir}"
    resources/scripts/misc/generate-configure-makefiles.sh
}

test_build_manual()
{
    cd "${topdir}"

    for ext in html pdf info ; do
	make "${ext}"
    done
}

# The build scripts tested in tihs function are meant to be included
# verbatim in the GNU Boot manual as commands, not scripts. Because of
# that they lack '#!/bin/env bash' and they also refer to files that
# users are instructed to create in the current directory (these are
# in manual/ and also included verbatim in the manual). This is why we
# really have to go in the manual directory and that we use bash
# <script> to test things.

test_build_guix_system_images()
{
    cd "${topdir}/manual"

    source "${topdir}"/config.sh

    if [ "${build_cpu}" = "x86_64" ] ; then
	bash build-guix-x86_64-linux.sh
    fi
    bash build-guix-i686-linux.sh
}

test_manual()
{
    generate_autotools_files
    test_build_manual
    test_build_guix_system_images
}

if [ $# -eq 1 ] && { [ "$1" = "-h" ] || [ "$1" == "--help" ] ;} ; then
    usage "${progname}"
    exit 0
elif [ $# -eq 0 ] ; then
    test_manual
else
    usage "${progname}"
    exit "${EX_USAGE}"
fi
