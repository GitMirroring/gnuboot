#!/usr/bin/env bash

#  helper script: builds GRUB2 source code
#
#	Copyright (C) 2014, 2015, 2020 Leah Rowe <info@minifree.org>
#   Copyright (C) 2015, 2016 Klemens Nanni <contact@autoboot.org>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

# This script assumes that the working directory is the root
# of git or release archive

[ "x${DEBUG+set}" = 'xset' ] && set -v
set -u -e

get_grub_version()
{
    git="../resources/wrappers/git"

    nr_patches="$(ls -d ../resources/grub/patches/* | wc -l)"

    # grub-2.12-226-g56ccc5ed5 -> 2.12-226-g56ccc5ed5
    grub_version="$(${git} describe | sed 's#^grub-##')"

    if [ "${nr_patches}" -eq 0 ] ; then
        echo "${grub_version}"
    elif [ "${nr_patches}" -eq 1 ] ; then
        echo "${grub_version} + 1 patch"
    else
        echo "${grub_version} + ${nr_patches} patches"
    fi
}

get_gnuboot_version()
{
    git="../resources/wrappers/git"

    if [ "${git} describe --tags --abbrev=0" = "${git} describe" ] ; then
        # convert 0.1-rc6 to 0.1 RC6
        "${git} describe" | sed 's#-# #' | awk '{print toupper($0)}'
    else
        # If we're not on a tag use something like that instead:
        # 0.1-rc6-101-g2198c81b1e
        echo "${git} describe"
    fi
}

# Build GRUB2 as coreboot payload

printf "Building GRUB\n"

# Check if GRUB has already been downloaded, and download it if not.
./download grub --is-done || ./download grub

# use a subshell to not end up in grub/ in case of build issues
(
cd grub/

# clean up first
[ -d Makefile ] && make distclean

./bootstrap --gnulib-srcdir=gnulib/ --no-git 

# Get some infos for displaying "2.12 from GNU Boot 0.1 RC1" in "GNU GRUB
# version 2.12 from GNU Boot 0.1 RC1" in the GRUB menu screen.
PACKAGE_VERSION="$(get_grub_version) from GNU Boot $(get_gnuboot_version)."

# build
./autogen.sh
./configure \
    --with-platform=coreboot \
    --with-unifont=../unifont.bdf \
    PACKAGE_VERSION="${PACKAGE_VERSION}"
make -j$(nproc)
)
